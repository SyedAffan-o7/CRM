{% extends 'base.html' %}

{% block title %}Role Management - CRM System{% endblock %}
{% block page_title %}Role Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Role Management</h2>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#roleModal">
                    <i class="bi bi-plus-circle"></i> Create New Role
                </button>
                <a href="{% url 'accounts_app:user_management' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-people"></i> Back to Users
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Roles Table -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">System Roles</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Role Name</th>
                        <th>Display Name</th>
                        <th>Description</th>
                        <th>Level</th>
                        <th>Status</th>
                        <th>Users</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role in roles %}
                    <tr>
                        <td><code>{{ role.name }}</code></td>
                        <td>{{ role.display_name }}</td>
                        <td>{{ role.description|default:"-" }}</td>
                        <td>
                            <span class="badge bg-info text-dark">{{ role.role_level }}</span>
                        </td>
                        <td>
                            {% if role.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ role.userprofile_set.count }}</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary edit-role-btn" 
                                        data-role-id="{{ role.id }}"
                                        data-role-name="{{ role.name }}"
                                        data-role-display="{{ role.display_name }}"
                                        data-role-description="{{ role.description }}"
                                        data-role-level="{{ role.role_level }}"
                                        data-role-active="{{ role.is_active|yesno:'true,false' }}"
                                        title="Edit Role">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info view-permissions-btn" 
                                        data-role-id="{{ role.id }}"
                                        title="View Permissions">
                                    <i class="bi bi-key"></i>
                                </button>
                                {% if role.userprofile_set.count == 0 %}
                                <form method="post" action="{% url 'accounts_app:delete_role' role.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                            onclick="return confirm('Are you sure you want to delete this role?')"
                                            title="Delete Role">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Permissions Overview -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Role Permissions Overview</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>Module</th>
                        <th>View</th>
                        <th>Create</th>
                        <th>Edit</th>
                        <th>Delete</th>
                        <th>Import</th>
                        <th>Export</th>
                    </tr>
                </thead>
                <tbody>
                    {% for permission in permissions %}
                    <tr>
                        <td>{{ permission.role.display_name }}</td>
                        <td>{{ permission.get_module_display }}</td>
                        <td>{% if permission.can_view %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                        <td>{% if permission.can_create %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                        <td>{% if permission.can_edit %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                        <td>{% if permission.can_delete %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                        <td>{% if permission.can_import %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                        <td>{% if permission.can_export %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Role Modal -->
<div class="modal fade" id="roleModal" tabindex="-1" aria-labelledby="roleModalTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleModalTitle">Create New Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" id="roleForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="role_id" id="roleId">
                    
                    <div class="form-group">
                        <label for="roleName">Role Name *</label>
                        <input type="text" class="form-control" name="name" id="roleName" required>
                        <small class="form-text text-muted">Internal name (e.g., SALESPERSON)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="roleDisplayName">Display Name *</label>
                        <input type="text" class="form-control" name="display_name" id="roleDisplayName" required>
                        <small class="form-text text-muted">Human-readable name (e.g., Sales Person)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="roleDescription">Description</label>
                        <textarea class="form-control" name="description" id="roleDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="roleLevel">Role Level *</label>
                        <input type="number" class="form-control" name="role_level" id="roleLevel" min="0" max="100" value="0" required>
                        <small class="form-text text-muted">Higher number = more permissions (0-100)</small>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="is_active" id="roleActive" checked>
                            <label class="form-check-label" for="roleActive">
                                Active Role
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="roleSubmitBtn">Create Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Edit role button event listeners
    document.querySelectorAll('.edit-role-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const id = this.dataset.roleId;
            const name = this.dataset.roleName;
            const displayName = this.dataset.roleDisplay;
            const description = this.dataset.roleDescription;
            const level = this.dataset.roleLevel;
            const isActive = this.dataset.roleActive === 'true';
            
            document.getElementById('roleModalTitle').textContent = 'Edit Role';
            document.getElementById('roleSubmitBtn').textContent = 'Update Role';
            document.getElementById('roleId').value = id;
            document.getElementById('roleName').value = name;
            document.getElementById('roleDisplayName').value = displayName;
            document.getElementById('roleDescription').value = description;
            document.getElementById('roleLevel').value = level;
            document.getElementById('roleActive').checked = isActive;
            
            const modal = new bootstrap.Modal(document.getElementById('roleModal'));
            modal.show();
        });
    });
    
    // View permissions button event listeners
    document.querySelectorAll('.view-permissions-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const roleId = this.dataset.roleId;
            // You can implement a detailed permissions view here
            alert('Permissions view for role ID: ' + roleId);
        });
    });
    
    // Reset form when modal is closed
    document.getElementById('roleModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('roleModalTitle').textContent = 'Create New Role';
        document.getElementById('roleSubmitBtn').textContent = 'Create Role';
        document.getElementById('roleForm').reset();
        document.getElementById('roleId').value = '';
    });
});
</script>
{% endblock %}
