{% extends 'base.html' %}

{% block title %}Enquiries - CRM System{% endblock %}
{% block page_title %}Enquiries Management{% endblock %}

{% block page_actions %}
<a href="{% url 'crm_app:lead_add' %}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Add New Enquiry
</a>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="d-flex align-items-center gap-3 flex-wrap">
            <div class="flex-grow-1" style="min-width: 200px;">
                <input type="text" class="form-control form-control-sm" id="search" name="search" value="{{ request.GET.search }}" placeholder="Search name, phone, company...">
            </div>
            <div style="min-width: 150px;">
                <select class="form-select form-select-sm" id="owner" name="owner">
                    <option value="">All Owners</option>
                    {% for owner in owners %}
                        <option value="{{ owner.id }}" {% if request.GET.owner == owner.id|stringformat:'s' %}selected{% endif %}>{{ owner.get_full_name|default:owner.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="min-width: 140px;">
                <select class="form-select form-select-sm" id="enquiry_status" name="enquiry_status">
                    <option value="">All Statuses</option>
                    {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if request.GET.enquiry_status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="min-width: 140px;">
                <select class="form-select form-select-sm" id="enquiry_stage" name="enquiry_stage">
                    <option value="">All Stages</option>
                    {% for value, label in stage_choices %}
                        <option value="{{ value }}" {% if request.GET.enquiry_stage == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="min-width: 140px;">
                <select class="form-select form-select-sm" id="country" name="country">
                    <option value="">All Countries</option>
                    {% for country in countries %}
                        <option value="{{ country }}" {% if request.GET.country == country %}selected{% endif %}>{{ country }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-funnel"></i> Filter
                </button>
                <a href="{% url 'crm_app:lead_list' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-clockwise"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Enquiries Table -->
<div class="card">
    <div class="card-body">
        {% if leads %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Country</th>
                            <th>Enquiry Owner</th>
                            <th>Stage</th>
                            <th>Status</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lead in leads %}
                        <tr>
                            <td>
                                <a href="{% url 'crm_app:lead_detail' lead.pk %}" class="text-decoration-none">
                                    <strong>{{ lead.contact_name }}</strong>
                                </a>
                            </td>
                            <td>{{ lead.phone_number }}</td>
                            <td>{{ lead.country }}</td>
                            <td>
                                {% if lead.created_by %}
                                    {{ lead.created_by.get_full_name|default:lead.created_by.username }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <select class="form-select form-select-sm stage-select" data-lead-id="{{ lead.pk }}" data-current-stage="{{ lead.enquiry_stage }}">
                                    <option value="enquiry_received" {% if lead.enquiry_stage == 'enquiry_received' %}selected{% endif %}>Enquiry Received</option>
                                    <option value="quotation_sent" {% if lead.enquiry_stage == 'quotation_sent' %}selected{% endif %}>Quotation Sent</option>
                                    <option value="negotiation" {% if lead.enquiry_stage == 'negotiation' %}selected{% endif %}>Negotiation</option>
                                    <option value="proforma_invoice_sent" {% if lead.enquiry_stage == 'proforma_invoice_sent' %}selected{% endif %}>Proforma Invoice Sent</option>
                                    <option value="won" {% if lead.enquiry_stage == 'won' %}selected{% endif %}>Won</option>
                                    <option value="lost" {% if lead.enquiry_stage == 'lost' %}selected{% endif %}>Lost</option>
                                </select>
                            </td>
                            <td>
                                <select class="form-select form-select-sm status-select" data-lead-id="{{ lead.pk }}" data-current-status="{{ lead.lead_status }}">
                                    <option value="fulfilled" {% if lead.lead_status == 'fulfilled' %}selected{% endif %}>Fulfilled</option>
                                    <option value="not_fulfilled" {% if lead.lead_status == 'not_fulfilled' %}selected{% endif %}>Not Fulfilled</option>
                                </select>
                            </td>
                            <td>
                                {% if lead.lead_status == 'not_fulfilled' %}
                                    <select class="form-select form-select-sm reason-select" data-lead-id="{{ lead.pk }}" data-current-reason="{{ lead.reason.pk|default:'' }}">
                                        <option value="">Select reason...</option>
                                        {% for reason in reasons %}
                                            <option value="{{ reason.pk }}" {% if lead.reason.pk == reason.pk %}selected{% endif %}>{{ reason.name }}</option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        
                        <!-- Product Modal for this lead -->
                        <div class="modal fade" id="productModal{{ lead.pk }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Products for {{ lead.contact_name }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        {% if lead.products_enquired.all %}
                                            <ul class="list-group">
                                                {% for product in lead.products_enquired.all %}
                                                    <li class="list-group-item">
                                                        <strong>{{ product.name }}</strong>
                                                        {% if product.category %}
                                                            <span class="badge bg-secondary ms-2">{{ product.category }}</span>
                                                        {% endif %}
                                                        {% if product.description %}
                                                            <p class="mb-0 mt-2 text-muted">{{ product.description }}</p>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p>No products selected for this enquiry.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-person-plus text-muted" style="font-size: 4rem;"></i>
                <h4 class="mt-3 text-muted">No enquiries found</h4>
                <p class="text-muted">Start by adding your first enquiry to the system.</p>
                <a href="{% url 'crm_app:lead_add' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add New Enquiry
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<nav aria-label="Enquiry pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.owner %}owner={{ request.GET.owner }}&{% endif %}{% if request.GET.enquiry_status %}enquiry_status={{ request.GET.enquiry_status }}&{% endif %}{% if request.GET.enquiry_stage %}enquiry_stage={{ request.GET.enquiry_stage }}&{% endif %}{% if request.GET.country %}country={{ request.GET.country }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.owner %}owner={{ request.GET.owner }}&{% endif %}{% if request.GET.enquiry_status %}enquiry_status={{ request.GET.enquiry_status }}&{% endif %}{% if request.GET.enquiry_stage %}enquiry_stage={{ request.GET.enquiry_stage }}&{% endif %}{% if request.GET.country %}country={{ request.GET.country }}&{% endif %}page={{ num }}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.owner %}owner={{ request.GET.owner }}&{% endif %}{% if request.GET.enquiry_status %}enquiry_status={{ request.GET.enquiry_status }}&{% endif %}{% if request.GET.enquiry_stage %}enquiry_stage={{ request.GET.enquiry_stage }}&{% endif %}{% if request.GET.country %}country={{ request.GET.country }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        {% endif %}
    </ul>
    
    <div class="text-center text-muted mt-2">
        <small>
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} enquiries
        </small>
    </div>
</nav>
{% endif %}

<!-- Invoice/PI Number Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceModalTitle">Enter Number</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <div class="mb-3">
                        <label for="invoiceInput" class="form-label" id="invoiceInputLabel">Number</label>
                        <input type="text" class="form-control" id="invoiceInput" required>
                        <div class="form-text" id="invoiceHelp"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="invoiceCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="invoiceSave">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Reason Modal -->
<div class="modal fade" id="reasonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Reason for Not Fulfilled</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reasonForm">
                    <div class="mb-3">
                        <label for="reasonSelect" class="form-label">Reason</label>
                        <select class="form-select" id="reasonSelect" required>
                            <option value="">Select a reason...</option>
                            {% for reason in reasons %}
                                <option value="{{ reason.pk }}">{{ reason.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveReason">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentLeadId = null;
    let currentStatusSelect = null;

    // Elements for invoice/proforma modal
    const invoiceModalEl = document.getElementById('invoiceModal');
    const invoiceModal = new bootstrap.Modal(invoiceModalEl);
    const invoiceTitleEl = document.getElementById('invoiceModalTitle');
    const invoiceLabelEl = document.getElementById('invoiceInputLabel');
    const invoiceInputEl = document.getElementById('invoiceInput');
    const invoiceHelpEl = document.getElementById('invoiceHelp');
    const invoiceSaveBtn = document.getElementById('invoiceSave');
    const invoiceCancelBtn = document.getElementById('invoiceCancel');

    let pendingStageSelect = null;
    let pendingStageValue = null;
    
    // Handle status change
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function() {
            const leadId = this.dataset.leadId;
            const newStatus = this.value;
            const previousStatus = this.dataset.currentStatus;
            
            updateStatus(leadId, newStatus, null, this);
        });
    });
    
    // Handle reason change
    document.querySelectorAll('.reason-select').forEach(select => {
        select.addEventListener('change', function() {
            const leadId = this.dataset.leadId;
            const reasonId = this.value;
            updateReason(leadId, reasonId, this);
        });
    });
    
    
    // Handle enquiry stage change
    document.querySelectorAll('.stage-select').forEach(select => {
        console.log('Adding event listener to stage select:', select);
        select.addEventListener('change', function() {
            console.log('Stage dropdown changed!');
            const leadId = this.dataset.leadId;
            const newStage = this.value;
            console.log('Lead ID:', leadId, 'New Stage:', newStage);

            if (newStage === 'proforma_invoice_sent') {
                console.log('Showing proforma invoice modal');
                pendingStageSelect = this;
                pendingStageValue = newStage;
                invoiceTitleEl.textContent = 'Proforma Invoice Number';
                invoiceLabelEl.textContent = 'Enter Proforma Invoice Number';
                invoiceHelpEl.textContent = 'A number is required to save this stage.';
                invoiceInputEl.value = '';
                invoiceModal.show();
            } else if (newStage === 'invoice_made' || newStage === 'invoice_sent') {
                console.log('Showing invoice modal');
                pendingStageSelect = this;
                pendingStageValue = newStage;
                invoiceTitleEl.textContent = 'Invoice Number';
                invoiceLabelEl.textContent = 'Enter Invoice Number';
                invoiceHelpEl.textContent = 'A number is required to save this stage.';
                invoiceInputEl.value = '';
                invoiceModal.show();
            } else {
                console.log('Calling updateEnquiryStage directly');
                updateEnquiryStage(leadId, newStage, this);
            }
        });
    });

    invoiceSaveBtn.addEventListener('click', function() {
        const num = invoiceInputEl.value.trim();
        if (!num) {
            invoiceInputEl.classList.add('is-invalid');
            return;
        }
        invoiceInputEl.classList.remove('is-invalid');
        invoiceModal.hide();
        if (!pendingStageSelect || !pendingStageValue) return;
        const leadId = pendingStageSelect.dataset.leadId;
        updateEnquiryStage(leadId, pendingStageValue, pendingStageSelect, num);
        pendingStageSelect = null;
        pendingStageValue = null;
    });

    invoiceCancelBtn.addEventListener('click', function() {
        // Revert selection
        if (pendingStageSelect) {
            pendingStageSelect.value = pendingStageSelect.dataset.currentStage;
        }
        pendingStageSelect = null;
        pendingStageValue = null;
    });
    
    // Handle reason selection
    document.getElementById('saveReason').addEventListener('click', function() {
        const reasonId = document.getElementById('reasonSelect').value;
        if (!reasonId) {
            alert('Please select a reason');
            return;
        }
        
        updateStatus(currentLeadId, 'not_fulfilled', reasonId, currentStatusSelect);
        bootstrap.Modal.getInstance(document.getElementById('reasonModal')).hide();
    });
    
    // Reset modal when closed without saving
    document.getElementById('reasonModal').addEventListener('hidden.bs.modal', function() {
        if (currentStatusSelect) {
            // Reset to previous value if modal was closed without saving
            currentStatusSelect.value = currentStatusSelect.dataset.currentStatus;
        }
        document.getElementById('reasonSelect').value = '';
        currentLeadId = null;
        currentStatusSelect = null;
    });
    
    async function updateStatus(leadId, status, reasonId, selectElement) {
        console.log('Updating status:', {leadId, status, reasonId});
        
        const formData = new FormData();
        formData.append('status', status);
        if (reasonId) {
            formData.append('reason_id', reasonId);
        }
        
        const csrftoken = window.csrftoken || getCookie('csrftoken');
        if (csrftoken) {
            formData.append('csrfmiddlewaretoken', csrftoken);
        }
        
        const url = `/enquiries/${leadId}/update-status/`;
        console.log('Calling URL:', url);
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            console.log('Response headers:', response.headers);

            let data;
            try {
                const responseText = await response.text();
                console.log('Raw response text:', responseText);
                data = JSON.parse(responseText);
                console.log('Parsed response data:', data);
            } catch (e) {
                console.error('Error parsing JSON response:', e);
                console.error('Response was not valid JSON');
                throw new Error(`Invalid response from server. Status: ${response.status}, Response: ${responseText || 'empty'}`);
            }

            if (!response.ok) {
                console.error('HTTP error response:', response.status, data);
                const error = new Error(data.error || `HTTP error! status: ${response.status}`);
                error.response = data;
                throw error;
            }

            if (!data.success) {
                console.error('Server returned success=false:', data);
                const error = new Error(data.error || 'Server returned success=false');
                error.response = data;
                throw error;
            }

            // Success case
            selectElement.dataset.currentStatus = status;
            // Reload page to show updated reason
            location.reload();
        } catch (error) {
            console.error('Error updating status:', error);
            console.error('Error response:', error.response);
            
            // Revert the select to its previous value
            selectElement.value = selectElement.dataset.currentStatus;
            
            // Prepare error message
            let errorMessage = 'Error updating status';
            
            if (error.response) {
                if (error.response.error) {
                    errorMessage = error.response.error;
                } else if (error.response.detail) {
                    errorMessage = error.response.detail;
                } else if (typeof error.response === 'string') {
                    errorMessage = error.response;
                } else if (Object.keys(error.response).length > 0) {
                    errorMessage = JSON.stringify(error.response);
                }
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            // Show error using existing toast system
            if (window.showToast) {
                window.showToast('Error', errorMessage, 'danger');
            } else {
                alert(errorMessage);
            }
        }
    }
    
    async function updateEnquiryStage(leadId, stage, selectElement, numberValue = null) {
        console.log('Updating enquiry stage:', { leadId, stage, numberValue });
        
        // Show loading state
        const originalText = selectElement.innerHTML;
        selectElement.disabled = true;
        selectElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        
        try {
            const formData = new FormData();
            formData.append('enquiry_stage', stage);
            
            // Only add these fields if they have values
            if (stage === 'proforma_invoice_sent' && numberValue) {
                formData.append('proforma_invoice_number', numberValue);
            }
            if ((stage === 'invoice_made' || stage === 'invoice_sent') && numberValue) {
                formData.append('invoice_number', numberValue);
            }
            
            // Get CSRF token from global variable or cookie
            const csrftoken = window.csrftoken || getCookie('csrftoken');
            
            if (!csrftoken) {
                console.error('CSRF token not found');
                throw new Error('Security token missing. Please refresh the page and try again.');
            }
            
            console.log('Form data:', Object.fromEntries(formData.entries()));
            
            const url = `/enquiries/${leadId}/update-stage/`;
            console.log('Making request to:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'
            });

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));

            let data;
            try {
                const responseText = await response.text();
                console.log('Raw response text:', responseText);
                data = responseText ? JSON.parse(responseText) : {};
                console.log('Parsed response data:', data);
            } catch (e) {
                console.error('Error parsing JSON response:', e);
                console.error('Response was not valid JSON');
                throw new Error(`Invalid response from server. Status: ${response.status}, Response: ${responseText || 'empty'}`);
            }

            if (!response.ok) {
                console.error('HTTP error response:', response.status, data);
                const error = new Error(data.error || `HTTP error! status: ${response.status}`);
                error.response = data;
                throw error;
            }

            if (!data.success) {
                console.error('Server returned success=false:', data);
                const error = new Error(data.error || 'Server returned success=false');
                error.response = data;
                throw error;
            }

            // Success: Update the UI to reflect the new stage
            if (selectElement) {
                // Find the selected option and update its text to show the stage was updated
                const selectedOption = selectElement.querySelector(`option[value="${stage}"]`);
                if (selectedOption) {
                    selectedOption.selected = true;
                }
                
                // Show success feedback
                selectElement.classList.add('is-valid');
                setTimeout(() => {
                    selectElement.classList.remove('is-valid');
                }, 2000);
            }
            
            // Show success message
            if (window.showToast) {
                window.showToast('Success', 'Enquiry stage updated successfully', 'success');
            }
            
            return data;
            
        } catch (error) {
            console.error('Error updating enquiry stage:', error);
            
            // Revert the select to its previous value
            if (selectElement) {
                selectElement.value = selectElement.dataset.previousValue || '';
            }
            
            let errorMessage = 'Error updating enquiry stage';
            
            if (error.response) {
                // Handle response from server with error details
                if (error.response.error) {
                    errorMessage = error.response.error;
                } else if (error.response.detail) {
                    errorMessage = error.response.detail;
                } else if (typeof error.response === 'string') {
                    errorMessage = error.response;
                } else if (Object.keys(error.response).length > 0) {
                    errorMessage = JSON.stringify(error.response);
                }
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            // Show error using existing toast system or fallback to alert
            if (typeof window.showToast === 'function') {
                window.showToast('Error', errorMessage, 'danger');
            } else {
                console.error('showToast not available, falling back to alert');
                alert(errorMessage);
            }
            
            // Re-throw the error for further handling if needed
            throw error;
            
        } finally {
            // Restore the select element state
            if (selectElement) {
                selectElement.disabled = false;
                selectElement.innerHTML = originalText;
            }
        }
    }
    
    function updateReason(leadId, reasonId, selectElement) {
        const formData = new FormData();
        formData.append('reason_id', reasonId);
        
        const csrftoken = window.csrftoken || getCookie('csrftoken');
        if (csrftoken) {
            formData.append('csrfmiddlewaretoken', csrftoken);
        }
        
        const url = `/enquiries/${leadId}/update-reason/`;
        
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            console.log('Response headers:', response.headers);

            if (!response.ok) {
                console.error('HTTP error response:', response.status);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return response.json();
        })
        .then(data => {
            console.log('Parsed response data:', data);

            if (!data.success) {
                console.error('Server returned success=false:', data);
                const error = new Error(data.error || 'Server returned success=false');
                error.response = data;
                throw error;
            }

            // Success case
            selectElement.dataset.currentReason = reasonId;
            // Show success feedback
            selectElement.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                selectElement.style.backgroundColor = '';
            }, 1000);
        })
        .catch(error => {
            console.error('Error updating reason:', error);
            console.error('Error response:', error.response);
            
            // Revert the select to its previous value
            selectElement.value = selectElement.dataset.currentReason;
            
            // Prepare error message
            let errorMessage = 'Error updating reason';
            
            if (error.response) {
                if (error.response.error) {
                    errorMessage = error.response.error;
                } else if (error.response.detail) {
                    errorMessage = error.response.detail;
                } else if (typeof error.response === 'string') {
                    errorMessage = error.response;
                } else if (Object.keys(error.response).length > 0) {
                    errorMessage = JSON.stringify(error.response);
                }
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            // Show error using existing toast system
            if (window.showToast) {
                window.showToast('Error', errorMessage, 'danger');
            } else {
                alert(errorMessage);
            }
        });
    }
    
    // Helper function to show toast notifications
    function showToast(title, message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;
        
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.id = toastId;
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 5000
        });
        bsToast.show();
        
        // Auto-remove toast after 5 seconds
        setTimeout(() => {
            const toastElement = document.getElementById(toastId);
            if (toastElement) {
                toastElement.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
