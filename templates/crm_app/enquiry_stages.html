{% extends 'base.html' %}
{% load static %}

{% block title %}Enquiry Stages - AAA CRM{% endblock %}
{% block page_title %}Enquiry Stages{% endblock %}

{% block page_actions %}
<a href="{% url 'crm_app:lead_add' %}" class="btn btn-cta">
    <i class="bi bi-plus-circle"></i> Add New Enquiry
</a>
{% endblock %}

{% block extra_css %}
<style>
/* Custom Kanban Styles - Modern Design */
.modern-kanban-wrapper {
  background-color: #f9fafb;
  border-radius: 1rem;
  padding: 1.5rem;
}

.modern-filter-card {
  background: white;
  border-radius: 0.75rem;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  border: 1px solid #e5e7eb;
  margin-bottom: 1.5rem;
  padding: 1rem;
}

.modern-grid {
  display: flex;
  gap: 1.5rem;
  overflow-x: auto;
  padding-bottom: 1rem;
  scroll-behavior: smooth;
}

/* Hide scrollbar but keep functionality */
.modern-grid::-webkit-scrollbar {
  height: 6px;
}

.modern-grid::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

.modern-grid::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

.modern-grid::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

.modern-stage-column {
  background: white;
  border-radius: 0.75rem;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  border: 1px solid #e5e7eb;
  height: 650px; /* Increased from 550px for more space */
  display: flex;
  flex-direction: column;
  min-width: 320px; /* Increased from 280px for better width */
  max-width: 320px; /* Increased from 280px for better width */
  flex-shrink: 0;
}

.modern-stage-header {
  padding: 1rem;
  font-weight: 600;
  border-radius: 0.75rem 0.75rem 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0; /* Header stays fixed */
  border-bottom: 1px solid #e5e7eb;
}

.modern-stage-body {
  padding: 1rem;
  flex: 1; /* Takes remaining space */
  overflow-y: auto; /* Scrollable content */
  overflow-x: hidden;
}

/* Custom scrollbar styling */
.modern-stage-body::-webkit-scrollbar {
  width: 6px;
}

.modern-stage-body::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

.modern-stage-body::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

.modern-stage-body::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

.modern-enquiry-card {
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  padding: 0.875rem;
  margin-bottom: 0.75rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-left: 4px solid;
  border: 1px solid #f1f5f9;
}

.modern-enquiry-card:hover {
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
  transform: translateY(-1px);
  border-color: #e2e8f0;
}

.modern-enquiry-card.locked {
  opacity: 0.75;
  border-left-color: #28a745 !important;
  position: relative;
}

.modern-enquiry-card.locked::after {
  content: 'âœ“';
  position: absolute;
  top: 5px;
  right: 5px;
  background: #28a745;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: bold;
}

.modern-empty-state {
  border: 2px dashed #d1d5db;
  padding: 2rem 1rem;
  text-align: center;
  color: #9ca3af;
  border-radius: 0.5rem;
  margin: 1rem 0;
}

/* Smooth scrolling behavior */
.modern-stage-body {
  scroll-behavior: smooth;
}

/* Add some spacing at the bottom for better UX */
.modern-stage-body::after {
  content: '';
  display: block;
  height: 0.5rem;
}

/* Stage Colors */
.stage-enquiry_received .modern-stage-header { background-color: #f3f4f6; color: #374151; }
.stage-enquiry_received .modern-enquiry-card { border-left-color: #6b7280; }

.stage-quotation_sent .modern-stage-header { background-color: #ecfeff; color: #0e7490; }
.stage-quotation_sent .modern-enquiry-card { border-left-color: #06b6d4; }

.stage-negotiation .modern-stage-header { background-color: #fef3c7; color: #92400e; }
.stage-negotiation .modern-enquiry-card { border-left-color: #f59e0b; }

.stage-proforma_invoice_sent .modern-stage-header { background-color: #fed7aa; color: #c2410c; }
.stage-proforma_invoice_sent .modern-enquiry-card { border-left-color: #f97316; }

.stage-invoice_sent .modern-stage-header { background-color: #e0e7ff; color: #3730a3; }
.stage-invoice_sent .modern-enquiry-card { border-left-color: #6366f1; }

.stage-lost .modern-stage-header { background-color: #fee2e2; color: #991b1b; }
.stage-lost .modern-enquiry-card { border-left-color: #ef4444; }

.modern-count-badge {
  background: rgba(255, 255, 255, 0.7);
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.modern-form-input {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.5rem;
  font-size: 0.875rem;
}

.modern-form-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modern-btn {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.875rem;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s;
}

.modern-btn-primary {
  background-color: #3b82f6;
  color: white;
  border: none;
}

.modern-btn-primary:hover {
  background-color: #2563eb;
}

.modern-btn-secondary {
  background-color: white;
  color: #374151;
  border: 1px solid #d1d5db;
}

.modern-btn-secondary:hover {
  background-color: #f9fafb;
}

/* Mobile responsiveness - keep horizontal scrolling */
@media (max-width: 767px) {
  .modern-kanban-wrapper {
    padding: 1rem;
  }

  .modern-stage-column {
    min-width: 20rem; /* Increased from 18rem for better mobile width */
    max-width: 20rem; /* Increased from 18rem for better mobile width */
    height: 580px; /* Increased from 480px for more space on mobile */
  }

  .modern-stage-header {
    padding: 0.75rem;
    font-size: 0.875rem;
  }

  .modern-stage-body {
    padding: 0.75rem;
  }

  .modern-enquiry-card {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
  }
}

/* Large screen optimizations */
@media (min-width: 1400px) {
  .modern-kanban-wrapper {
    padding: 2rem;
  }

  .modern-stage-column {
    height: 680px; /* Increased from 580px for more space on large screens */
  }
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Modern Filter Section -->
<div class="modern-filter-card">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-2">
            <label for="from_date" class="form-label small mb-1">From Date</label>
            <input type="date" class="modern-form-input" id="from_date" name="from_date" value="{{ from_date|date:'Y-m-d' }}">
        </div>
        <div class="col-md-2">
            <label for="to_date" class="form-label small mb-1">To Date</label>
            <input type="date" class="modern-form-input" id="to_date" name="to_date" value="{{ to_date|date:'Y-m-d' }}">
        </div>
        <div class="col-md-2">
            <label for="month_filter" class="form-label small mb-1">Month</label>
            <select class="modern-form-input" id="month_filter" name="month_filter">
                <option value="">Select Month</option>
                <option value="1" {% if selected_month == 1 %}selected{% endif %}>January</option>
                <option value="2" {% if selected_month == 2 %}selected{% endif %}>February</option>
                <option value="3" {% if selected_month == 3 %}selected{% endif %}>March</option>
                <option value="4" {% if selected_month == 4 %}selected{% endif %}>April</option>
                <option value="5" {% if selected_month == 5 %}selected{% endif %}>May</option>
                <option value="6" {% if selected_month == 6 %}selected{% endif %}>June</option>
                <option value="7" {% if selected_month == 7 %}selected{% endif %}>July</option>
                <option value="8" {% if selected_month == 8 %}selected{% endif %}>August</option>
                <option value="9" {% if selected_month == 9 %}selected{% endif %}>September</option>
                <option value="10" {% if selected_month == 10 %}selected{% endif %}>October</option>
                <option value="11" {% if selected_month == 11 %}selected{% endif %}>November</option>
                <option value="12" {% if selected_month == 12 %}selected{% endif %}>December</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="year_filter" class="form-label small mb-1">Year</label>
            <select class="modern-form-input" id="year_filter" name="year_filter">
                <option value="">Current Year</option>
                <option value="2023" {% if selected_year == 2023 %}selected{% endif %}>2023</option>
                <option value="2024" {% if selected_year == 2024 %}selected{% endif %}>2024</option>
                <option value="2025" {% if selected_year == 2025 %}selected{% endif %}>2025</option>
                <option value="2026" {% if selected_year == 2026 %}selected{% endif %}>2026</option>
            </select>
        </div>
        <div class="col-md-4">
            <button type="submit" class="modern-btn modern-btn-primary me-2">
                <i class="bi bi-funnel"></i> Apply
            </button>
            <a href="{% url 'crm_app:enquiry_stages' %}" class="modern-btn modern-btn-secondary">
                <i class="bi bi-arrow-clockwise"></i> Reset
            </a>
        </div>
    </form>
</div>

<!-- Modern Kanban Board -->
<div class="modern-kanban-wrapper">
    <div class="modern-grid">
        {% for stage_value, stage_data in stages.items %}
        {% if stage_value != 'invoice_made' and stage_value != 'invoice_sent' or stage_data.leads|length > 0 %}
        <div class="modern-stage-column stage-{{ stage_value }}">
            <!-- Stage Header -->
            <div class="modern-stage-header">
                <span>{{ stage_data.name }}</span>
                <span class="modern-count-badge">{{ stage_data.leads|length }}</span>
            </div>
            
            <!-- Stage Body -->
            <div class="modern-stage-body">
                {% for enquiry in stage_data.leads %}
                <div class="modern-enquiry-card{% if enquiry.is_locked %} locked{% endif %}">
                    <!-- Contact Name -->
                    <div class="fw-bold mb-2">
                        <a href="{% url 'crm_app:lead_detail' enquiry.pk %}" class="text-decoration-none text-dark">
                            {{ enquiry.contact_name }}
                        </a>
                    </div>
                    
                    <!-- Company -->
                    {% if enquiry.company_name %}
                    <div class="d-flex align-items-center text-muted small mb-2">
                        <i class="bi bi-building me-2"></i>
                        <span>{{ enquiry.company_name }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Phone -->
                    <div class="d-flex align-items-center text-muted small mb-3">
                        <a
                            href="https://wa.me/{{ enquiry.phone_number|cut:' '|cut:'+'|cut:'-'|cut:'('|cut:')'|cut:'.'|cut:'/' }}"
                            class="me-2 text-success"
                            target="_blank"
                            rel="noopener noreferrer"
                            title="Open WhatsApp chat"
                            aria-label="Open WhatsApp chat"
                        >
                            <i class="bi bi-whatsapp"></i>
                        </a>
                        <span>{{ enquiry.phone_number }}</span>
                    </div>
                    
                    <!-- Products -->
                    {% if enquiry.products_enquired.exists %}
                    <div class="mb-3">
                        {% for product in enquiry.products_enquired.all %}
                        <span class="badge bg-secondary me-1 mb-1">{{ product.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Stage Selector -->
                    <div class="mb-3">
                        <select class="form-select form-select-sm stage-select" 
                                data-lead-id="{{ enquiry.pk }}" 
                                data-current-stage="{{ enquiry.enquiry_stage }}"
                                {% if enquiry.is_locked %}disabled title="This enquiry is locked and cannot be modified after fulfillment"{% endif %}>
                            <option value="enquiry_received" {% if enquiry.enquiry_stage == 'enquiry_received' %}selected{% endif %}>Enquiry Received</option>
                            <option value="quotation_sent" {% if enquiry.enquiry_stage == 'quotation_sent' %}selected{% endif %}>Quotation Sent</option>
                            <option value="negotiation" {% if enquiry.enquiry_stage == 'negotiation' %}selected{% endif %}>Negotiation</option>
                            <option value="proforma_invoice_sent" {% if enquiry.enquiry_stage == 'proforma_invoice_sent' %}selected{% endif %}>Proforma Invoice Sent</option>
                            <option value="invoice_sent" {% if enquiry.enquiry_stage == 'invoice_sent' %}selected{% endif %}>Invoice Sent</option>
                            <option value="lost" {% if enquiry.enquiry_stage == 'lost' %}selected{% endif %}>Lost</option>
                        </select>
                    </div>
                    
                    <!-- Footer -->
                    <div class="d-flex justify-content-between align-items-center small text-muted pt-2 border-top">
                        <span>{{ enquiry.created_date|date:"M d" }}</span>
                        <span class="fw-medium">
                            {% if enquiry.assigned_sales_person %}
                                {{ enquiry.assigned_sales_person.first_name|default:enquiry.assigned_sales_person.username }}
                            {% else %}
                                Unassigned
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% empty %}
                <!-- Empty State -->
                <div class="modern-empty-state">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">No enquiries in this stage</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
    <div class="modal fade" id="invoiceCreateWarningModal" tabindex="-1" aria-labelledby="invoiceCreateWarningTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="invoiceCreateWarningTitle">Create Invoice First</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">To mark this enquiry as <strong>Invoice Sent</strong>, please create an invoice first.</p>
                    <p class="mb-0 small text-muted">Use the Invoices section to create an invoice for this enquiry. After saving the invoice, the stage will update automatically.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary btn-sm" id="invoiceCreateWarningGoBtn">Go to Invoices</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="invoiceModalTitle">Enter Number</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="invoiceForm">
                        <div class="mb-3">
                            <label for="invoiceInput" class="form-label" id="invoiceInputLabel">Number</label>
                            <input type="text" class="form-control" id="invoiceInput" required>
                            <div class="form-text" id="invoiceHelp"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="invoiceCancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="invoiceSave">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reason Modal -->
    <div class="modal fade" id="reasonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Reason for Not Fulfilled</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reasonForm">
                        <div class="mb-3">
                            <label for="reasonSelect" class="form-label">Reason</label>
                            <select class="form-select" id="reasonSelect" required>
                                <option value="">Select a reason...</option>
                                {% for reason in reasons %}
                                    <option value="{{ reason.pk }}">{{ reason.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveReason">Save</button>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  // Configuration for enquiries.js
  window.leadListConfig = {
    // CSRF will be read from cookie in enquiries.js; this is optional
    csrfToken: window.csrftoken || null,
    urls: {
      updateStage: "{% url 'crm_app:lead_update_stage' 999 %}",
      updateStatus: "{% url 'crm_app:lead_update_status' 999 %}",
      updateReason: "{% url 'crm_app:lead_update_reason' 999 %}",
      invoiceAdd: "{% url 'invoices_app:invoice_add' %}"
    }
  };
</script>
<script src="{% static 'js/enquiries.js' %}"></script>
{% endblock %}
